<!doctype html>
<html lang="ko">
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>API Console</title>
	<link rel="preconnect" href="https://fonts.googleapis.com">
	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link href="https://fonts.googleapis.com/css2?family=Newsreader:opsz,wght@6..72,400;6..72,600&family=Space+Grotesk:wght@400;600;700&display=swap" rel="stylesheet">
	<style>
		:root {
			--ink: #10131a;
			--ink-soft: #2f3340;
			--muted: #6f7484;
			--accent: #ff6b3d;
			--accent-2: #3d7bff;
			--accent-3: #13b886;
			--paper: #f5f0e8;
			--card: #ffffff;
			--line: #e7e1d6;
			--shadow: 0 20px 50px rgba(16, 19, 26, 0.16);
			--radius: 20px;
		}

		* {
			box-sizing: border-box;
		}

		body {
			margin: 0;
			font-family: "Space Grotesk", "Apple SD Gothic Neo", "Malgun Gothic", sans-serif;
			color: var(--ink);
			background: radial-gradient(circle at 20% 20%, #fff1df 0%, transparent 55%),
				radial-gradient(circle at 80% 0%, #e7efff 0%, transparent 52%),
				linear-gradient(180deg, #f8f3ea 0%, #efe8dd 100%);
			min-height: 100vh;
		}

		.shell {
			max-width: 1180px;
			margin: 0 auto;
			padding: 40px 24px 64px;
			display: grid;
			gap: 24px;
		}

		.header {
			display: grid;
			gap: 8px;
			animation: rise 0.7s ease both;
		}

		.title {
			font-family: "Newsreader", serif;
			font-size: clamp(28px, 3vw, 44px);
			margin: 0;
			letter-spacing: -0.02em;
		}

		.subtitle {
			margin: 0;
			color: var(--muted);
			font-size: 15px;
		}

		.header-actions {
			display: flex;
			gap: 10px;
			flex-wrap: wrap;
		}

		.link-chip {
			text-decoration: none;
			background: #ffffff;
			border: 1px solid var(--line);
			padding: 8px 14px;
			border-radius: 999px;
			color: var(--ink-soft);
			font-size: 12px;
			font-weight: 600;
		}

		.grid {
			display: grid;
			grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
			gap: 20px;
		}

		.card {
			background: var(--card);
			border-radius: var(--radius);
			padding: 22px;
			box-shadow: var(--shadow);
			border: 1px solid var(--line);
			animation: floatIn 0.7s ease both;
		}

		.card h2 {
			margin: 0 0 14px;
			font-size: 18px;
		}

		label {
			font-size: 13px;
			color: var(--muted);
			display: block;
			margin-bottom: 6px;
		}

		input, textarea, select {
			width: 100%;
			padding: 12px 14px;
			border-radius: 12px;
			border: 1px solid #e8e2d8;
			font-family: inherit;
			font-size: 14px;
			background: #fbfaf8;
			color: var(--ink);
		}

		textarea {
			min-height: 120px;
			resize: vertical;
		}

		.row {
			display: grid;
			grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
			gap: 12px;
		}

		.actions {
			display: flex;
			gap: 10px;
			flex-wrap: wrap;
			margin-top: 14px;
		}

		.inline-actions {
			display: flex;
			gap: 8px;
			align-items: center;
		}

		.inline-actions input {
			flex: 1;
		}

		.list {
			display: flex;
			flex-direction: column;
			gap: 8px;
			margin-top: 12px;
		}

		.list-item {
			text-align: left;
			padding: 10px 12px;
			border-radius: 12px;
			border: 1px solid var(--line);
			background: #ffffff;
			font-size: 13px;
			cursor: pointer;
		}

		.list-item:hover {
			border-color: var(--accent-2);
		}

		.list-empty {
			padding: 12px;
			border-radius: 12px;
			border: 1px dashed var(--line);
			color: var(--ink-soft);
			font-size: 13px;
			text-align: center;
		}

		button {
			border: none;
			padding: 12px 16px;
			border-radius: 999px;
			font-family: inherit;
			font-weight: 600;
			cursor: pointer;
			transition: transform 0.2s ease, box-shadow 0.2s ease;
		}

		button.primary {
			background: var(--accent);
			color: #fff;
			box-shadow: 0 12px 30px rgba(255, 107, 61, 0.35);
		}

		button.secondary {
			background: var(--accent-2);
			color: #fff;
			box-shadow: 0 12px 30px rgba(61, 123, 255, 0.35);
		}

		button.success {
			background: var(--accent-3);
			color: #fff;
			box-shadow: 0 12px 30px rgba(19, 184, 134, 0.35);
		}

		button.ghost {
			background: #f2ece3;
			color: var(--ink-soft);
		}

		button:active {
			transform: scale(0.98);
		}

		.kv {
			display: grid;
			gap: 8px;
			font-size: 13px;
			color: var(--muted);
		}

		.kv strong {
			color: var(--ink);
		}

		.badge {
			display: inline-flex;
			align-items: center;
			gap: 6px;
			padding: 6px 12px;
			border-radius: 999px;
			background: #fff4e6;
			color: #b9501a;
			font-size: 12px;
		}

		.log {
			font-family: "Space Grotesk", sans-serif;
			font-size: 13px;
			background: #0f1117;
			color: #f3f3f3;
			padding: 16px;
			border-radius: 16px;
			min-height: 180px;
			white-space: pre-wrap;
		}

		.footer-note {
			font-size: 12px;
			color: var(--muted);
			margin-top: 6px;
		}

		/* 댓글 트리 스타일 */
		.comment-tree {
			margin-top: 20px;
			display: grid;
			gap: 12px;
		}

		.comment-item {
			background: #fbfaf8;
			border: 1px solid var(--line);
			border-radius: 12px;
			padding: 12px;
			position: relative;
			transition: all 0.2s ease;
		}

		.comment-item:hover {
			border-color: var(--accent-2);
			background: #fff;
		}

		.comment-item.depth-1 { margin-left: 24px; border-left: 3px solid var(--accent-2); }
		.comment-item.depth-2 { margin-left: 48px; border-left: 3px solid var(--accent-3); }
		.comment-item.depth-3 { margin-left: 72px; border-left: 3px solid var(--accent); }

		.comment-header {
			display: flex;
			justify-content: space-between;
			align-items: center;
			margin-bottom: 6px;
			font-size: 12px;
		}

		.comment-author { font-weight: 700; color: var(--ink); }
		.comment-meta { color: var(--muted); }
		.comment-body { font-size: 14px; color: var(--ink-soft); line-height: 1.5; }

		.comment-btns {
			margin-top: 8px;
			display: flex;
			gap: 6px;
		}

		.comment-btns button {
			padding: 4px 10px;
			font-size: 11px;
			background: #eee;
			color: #555;
			box-shadow: none;
		}

		@keyframes rise {
			from { opacity: 0; transform: translateY(12px); }
			to { opacity: 1; transform: translateY(0); }
		}

		@keyframes floatIn {
			from { opacity: 0; transform: translateY(16px); }
			to { opacity: 1; transform: translateY(0); }
		}

		@media (max-width: 720px) {
			.shell {
				padding: 28px 18px 40px;
			}

			.card {
				padding: 18px;
			}
		}
	</style>
</head>
<body>
	<div class="shell">
		<header class="header">
			<span class="badge">dev profile 전용</span>
			<h1 class="title">Posts / Comments API Console</h1>
			<p class="subtitle">게시글과 댓글 CRUD 흐름을 JWT 토큰으로 확인합니다. 토큰은 Auth Console과 공유됩니다.</p>
			<div class="header-actions">
				<a class="link-chip" href="/dev/auth/console">Auth Console</a>
				<a class="link-chip" href="/dev/auth/console/claims">Claims JSON</a>
				<a class="link-chip" href="/dev/file-console">File Upload Console</a>
				<a class="link-chip" href="/dev/report-predict-console">Report Predict Console</a>
			</div>
		</header>

		<section class="grid">
			<div class="card" style="animation-delay: 0.05s;">
				<h2>토큰 상태</h2>
				<div class="kv">
					<div><strong>Access</strong> <span id="access-preview">-</span></div>
					<div><strong>Refresh</strong> <span id="refresh-preview">-</span></div>
					<div><strong>최근 Post ID</strong> <span id="last-post">-</span></div>
					<div><strong>최근 Comment ID</strong> <span id="last-comment">-</span></div>
				</div>
				<div class="actions">
					<button class="ghost" type="button" id="clear-session">세션 초기화</button>
				</div>
				<p class="footer-note">Auth Console에서 로그인 후 이 페이지를 새로고침하면 토큰이 반영됩니다.</p>
			</div>

			<div class="card" style="animation-delay: 0.06s;">
				<h2>DART 기업 동기화</h2>
				<div class="actions">
					<button class="primary" type="button" id="dart-corp-sync">기업 목록 동기화 실행</button>
				</div>
				<p class="footer-note">관리자 토큰(ROLE_ADMIN) 필요. POST /admin/dart/corp-sync</p>
			</div>

			<div class="card" style="animation-delay: 0.07s;">
				<h2>보고서 지표 업로드</h2>
				<div class="row">
					<div>
						<label for="report-quarter-key">quarterKey</label>
						<input id="report-quarter-key" type="number" placeholder="20253">
					</div>
				</div>
				<label for="report-file" style="margin-top: 12px;">excel</label>
				<input id="report-file" type="file" accept=".xlsx">
				<div class="actions">
					<button class="secondary" type="button" id="report-import">업로드 실행</button>
				</div>
				<p class="footer-note">관리자 토큰(ROLE_ADMIN) 필요. POST /admin/reports/metrics/import</p>
			</div>

			<div class="card" style="animation-delay: 0.072s;">
				<h2>보고서 지표 예측값 적재</h2>
				<div class="row">
					<div>
						<label for="predict-stock-code">stockCode</label>
						<input id="predict-stock-code" type="text" placeholder="000020">
					</div>
					<div>
						<label for="predict-quarter-key">quarterKey</label>
						<input id="predict-quarter-key" type="number" placeholder="20253">
					</div>
				</div>
				<label for="predict-metrics" style="margin-top: 12px;">metrics (metric_name_en: value)</label>
				<textarea id="predict-metrics" placeholder='{"ROA":1.23,"OperatingProfitMargin":2.34,"DebtToEquityRatio":null}'></textarea>
				<div class="actions">
					<button class="secondary" type="button" id="predict-import">예측값 적재</button>
				</div>
				<p class="footer-note">관리자 토큰(ROLE_ADMIN) 필요. POST /admin/reports/metrics/predict</p>
			</div>

			<div class="card" style="animation-delay: 0.073s;">
				<h2>보고서 지표+PDF 발행</h2>
				<div class="row">
					<div>
						<label for="publish-stock-code">stockCode</label>
						<input id="publish-stock-code" type="text" placeholder="000020">
					</div>
					<div>
						<label for="publish-quarter-key">quarterKey</label>
						<input id="publish-quarter-key" type="number" placeholder="20253">
					</div>
					<div>
						<label for="publish-value-type">valueType</label>
						<select id="publish-value-type">
							<option value="ACTUAL" selected>ACTUAL</option>
							<option value="PREDICTED">PREDICTED</option>
						</select>
					</div>
				</div>
				<label for="publish-metrics" style="margin-top: 12px;">metrics (metric_name_en: value)</label>
				<textarea id="publish-metrics" placeholder='{"ROA":1.23,"OperatingProfitMargin":2.34}'></textarea>
				<label for="publish-file" style="margin-top: 12px;">PDF</label>
				<input id="publish-file" type="file" accept="application/pdf">
				<div class="actions">
					<button class="secondary" type="button" id="publish-report">발행 실행</button>
				</div>
				<p class="footer-note">관리자 토큰(ROLE_ADMIN) 필요. POST /admin/reports/metrics/publish</p>
			</div>

			<div class="card" style="animation-delay: 0.075s;">
				<h2>보고서 지표 조회(분기별)</h2>
				<div class="row">
					<div>
						<label for="report-company-keyword">기업명 검색</label>
						<div class="inline-actions">
							<input id="report-company-keyword" type="text" placeholder="기업명/영문명">
							<button class="ghost" type="button" id="report-company-search">검색</button>
						</div>
					</div>
				</div>
				<div class="list" id="report-company-results" aria-live="polite"></div>
				<div class="row" style="margin-top: 12px;">
					<div>
						<label for="report-stock-code">stockCode</label>
						<input id="report-stock-code" type="text" placeholder="000020">
					</div>
					<div>
						<label for="report-from-quarter-key">fromQuarterKey</label>
						<input id="report-from-quarter-key" type="number" placeholder="20244">
					</div>
					<div>
						<label for="report-to-quarter-key">toQuarterKey</label>
						<input id="report-to-quarter-key" type="number" placeholder="20253">
					</div>
				</div>
				<div class="actions">
					<button class="secondary" type="button" id="report-grouped-query">조회 실행</button>
				</div>
					<p class="footer-note">사용자 토큰(ROLE_USER) 필요. GET /reports/metrics/grouped</p>
			</div>

			<div class="card" style="animation-delay: 0.08s;">
				<h2>게시글 목록</h2>
				<div class="row">
					<div>
						<label for="page">page</label>
						<input id="page" type="number" min="1" value="1">
					</div>
					<div>
						<label for="size">size</label>
						<input id="size" type="number" min="1" value="10">
					</div>
				</div>
				<div class="row" style="margin-top: 12px;">
					<div>
						<label for="sortBy">sortBy</label>
						<input id="sortBy" type="text" value="createdAt">
					</div>
					<div>
						<label for="direction">direction</label>
						<select id="direction">
							<option value="DESC" selected>DESC</option>
							<option value="ASC">ASC</option>
						</select>
					</div>
				</div>
				<div class="actions">
					<button class="secondary" type="button" id="list-posts">목록 조회</button>
				</div>
			</div>

			<div class="card" style="animation-delay: 0.12s;">
				<h2>게시글 생성</h2>
				<div class="row">
					<div>
						<label for="create-category">category</label>
						<select id="create-category"></select>
					</div>
					<div>
						<label for="create-title">title</label>
						<input id="create-title" type="text" placeholder="제목">
					</div>
				</div>
				<label for="create-content" style="margin-top: 12px;">content</label>
				<textarea id="create-content" placeholder="내용"></textarea>
				<div class="actions">
					<button class="primary" type="button" id="create-post">게시글 생성</button>
				</div>
			</div>

			<div class="card" style="animation-delay: 0.16s;">
				<h2>게시글 조회 / 수정 / 삭제</h2>
				<label for="post-id">postId</label>
				<input id="post-id" type="number" placeholder="최근 ID 자동 사용">
				<div class="row" style="margin-top: 12px;">
					<div>
						<label for="update-title">title</label>
						<input id="update-title" type="text" placeholder="수정 제목">
					</div>
					<div>
						<label for="update-category">category</label>
						<select id="update-category"></select>
					</div>
				</div>
				<label for="update-content" style="margin-top: 12px;">content</label>
				<textarea id="update-content" placeholder="수정 내용"></textarea>
				<div class="actions">
					<button class="ghost" type="button" id="get-post">조회</button>
					<button class="success" type="button" id="update-post">수정</button>
					<button class="ghost" type="button" id="delete-post">삭제</button>
				</div>
			</div>

			<div class="card" style="animation-delay: 0.2s;">
				<h2>카테고리 목록</h2>
				<div id="category-list" class="kv"></div>
				<p class="footer-note">카테고리는 dev 시드 데이터를 기반으로 표시됩니다.</p>
			</div>

			<div class="card" style="animation-delay: 0.2s;">
				<h2>댓글 조회 / 생성</h2>
				<label for="comment-post-id">postId</label>
				<input id="comment-post-id" type="number" placeholder="최근 Post ID">
				<label for="comment-content" style="margin-top: 12px;">content</label>
				<textarea id="comment-content" placeholder="댓글 내용"></textarea>
				<label for="comment-parent" style="margin-top: 12px;">parentId (대댓글)</label>
				<input id="comment-parent" type="number" placeholder="없으면 비움">
				<div class="actions">
					<button class="secondary" type="button" id="list-comments">댓글 목록</button>
					<button class="primary" type="button" id="create-comment">댓글 생성</button>
				</div>
				<div id="comment-tree" class="comment-tree"></div>
			</div>

			<div class="card" style="animation-delay: 0.24s;">
				<h2>댓글 수정 / 삭제</h2>
				<label for="comment-id">commentId</label>
				<input id="comment-id" type="number" placeholder="최근 Comment ID">
				<label for="comment-update" style="margin-top: 12px;">content</label>
				<textarea id="comment-update" placeholder="수정 내용"></textarea>
				<div class="actions">
					<button class="success" type="button" id="update-comment">댓글 수정</button>
					<button class="ghost" type="button" id="delete-comment">댓글 삭제</button>
				</div>
			</div>
		</section>

		<section class="card" style="animation-delay: 0.3s;">
			<h2>응답 로그</h2>
			<pre class="log" id="log">대기 중...</pre>
		</section>
	</div>

	<script>
		const storageKey = "auth-console.tokens";
		const sessionKey = "dev-console.state";

		const logEl = document.getElementById("log");
		const categoryList = document.getElementById("category-list");
		const createCategorySelect = document.getElementById("create-category");
		const updateCategorySelect = document.getElementById("update-category");

		const accessPreview = document.getElementById("access-preview");
		const refreshPreview = document.getElementById("refresh-preview");
		const lastPostEl = document.getElementById("last-post");
		const lastCommentEl = document.getElementById("last-comment");
		const commentTree = document.getElementById("comment-tree");

		const state = {
			accessToken: "",
			refreshToken: "",
			lastPostId: "",
			lastCommentId: ""
		};

		const setLog = (payload) => {
			if (!logEl) return;
			logEl.textContent = typeof payload === "string" ? payload : JSON.stringify(payload, null, 2);
		};

		const loadState = () => {
			try {
				const raw = localStorage.getItem(storageKey);
				if (raw) {
					const data = JSON.parse(raw);
					state.accessToken = data.accessToken || "";
					state.refreshToken = data.refreshToken || "";
				}
				const sessionRaw = localStorage.getItem(sessionKey);
				if (sessionRaw) {
					const data = JSON.parse(sessionRaw);
					state.lastPostId = data.lastPostId || "";
					state.lastCommentId = data.lastCommentId || "";
				}
			} catch (e) {
				console.error("Failed to load state", e);
				setLog("상태 로드 중 오류 발생: " + e.message);
			}
		};

		const saveSession = () => {
			localStorage.setItem(sessionKey, JSON.stringify({
				lastPostId: state.lastPostId,
				lastCommentId: state.lastCommentId
			}));
		};

		const updateTokenView = () => {
			if (!accessPreview || !refreshPreview || !lastPostEl || !lastCommentEl) return;
			accessPreview.textContent = state.accessToken ? state.accessToken.slice(0, 30) + "..." : "-";
			refreshPreview.textContent = state.refreshToken ? state.refreshToken.slice(0, 30) + "..." : "-";
			lastPostEl.textContent = state.lastPostId || "-";
			lastCommentEl.textContent = state.lastCommentId || "-";
		};

		const apiFetch = async (url, options = {}) => {
			const headers = options.headers || {};
			if (state.accessToken) {
				headers.Authorization = "Bearer " + state.accessToken;
			}
			return fetch(url, { ...options, headers });
		};

		const readNumber = (id, fallback) => {
			const el = document.getElementById(id);
			if (!el) return fallback;
			const value = el.value;
			if (value === "" || value === null || value === undefined) {
				return fallback;
			}
			return Number(value);
		};

		const readText = (id) => {
			const el = document.getElementById(id);
			return el ? el.value.trim() : "";
		};

		const renderCategories = (items) => {
			if (!categoryList || !createCategorySelect || !updateCategorySelect) return;
			
			categoryList.innerHTML = "";
			createCategorySelect.innerHTML = "";
			updateCategorySelect.innerHTML = "";

			if (!items || items.length === 0) {
				categoryList.textContent = "카테고리가 없습니다.";
				return;
			}

			const placeholder = document.createElement("option");
			placeholder.value = "";
			placeholder.textContent = "카테고리 선택";
			createCategorySelect.appendChild(placeholder.cloneNode(true));
			updateCategorySelect.appendChild(placeholder.cloneNode(true));

			items.forEach((item) => {
				const label = `${item.name} (${item.id})`;
				const entry = document.createElement("div");
				entry.innerHTML = `<strong>${item.name}</strong> <span>(ID: ${item.id})</span>`;
				categoryList.appendChild(entry);

				const option = document.createElement("option");
				option.value = item.id;
				option.textContent = label;
				createCategorySelect.appendChild(option.cloneNode(true));
				updateCategorySelect.appendChild(option);
			});
		};

		        const loadCategories = async () => {
		            try {
		                const response = await fetch("/dev/categories");
		                if (!response.ok) throw new Error("Status: " + response.status);
		                const data = await response.json();
		                renderCategories(data.data || []);
		            } catch (error) {
		                if (categoryList) categoryList.textContent = "카테고리 조회 실패: " + error.message;
		            }
		        };
		
		        const renderCommentTree = (comments) => {
		            if (!commentTree) return;
		            commentTree.innerHTML = "";
		
		            if (!comments || comments.length === 0) {
		                commentTree.innerHTML = "<p style='font-size: 13px; color: var(--muted);'>댓글이 없습니다.</p>";
		                return;
		            }
		
		            comments.forEach(c => {
		                const item = document.createElement("div");
		                item.className = `comment-item depth-${Math.min(c.depth, 3)}`;
		                
		                const date = new Date(c.createdAt).toLocaleString();
		                item.innerHTML = `
		                    <div class="comment-header">
		                        <span class="comment-author">User ${c.userId} (ID: ${c.id})</span>
		                        <span class="comment-meta">${date}</span>
		                    </div>
		                    <div class="comment-body">${c.content}</div>
		                    <div class="comment-btns">
		                        <button type="button" onclick="selectForReply(${c.id})">답글</button>
		                        <button type="button" onclick="selectForEdit(${c.id}, '${c.content.replace(/'/g, "\'")}')">선택</button>
		                    </div>
		                `;
		                commentTree.appendChild(item);
		            });
		        };
		
		        window.selectForReply = (id) => {
		            document.getElementById("comment-parent").value = id;
		            document.getElementById("comment-content").focus();
		            setLog(`댓글 ${id}번에 대한 답글 작성을 준비합니다.`);
		        };
		
		        window.selectForEdit = (id, content) => {
		            document.getElementById("comment-id").value = id;
		            document.getElementById("comment-update").value = content;
		            document.getElementById("comment-update").focus();
		            setLog(`댓글 ${id}번이 수정 대상으로 선택되었습니다.`);
		        };
		
		        loadCategories();
		// 초기화 실행
		const init = () => {
			loadState();
			updateTokenView();
			loadCategories();
			setLog("콘솔 로드 완료. Auth Console에서 로그인하면 토큰이 자동 동기화됩니다.");
		};

		// Storage 이벤트 리스너 (탭 간 동기화)
		window.addEventListener("storage", (e) => {
			if (e.key === storageKey) {
				loadState();
				updateTokenView();
				setLog("타사 콘솔(Auth Console)에서 토큰 변경이 감지되어 업데이트되었습니다.");
			}
		});

		window.addEventListener("DOMContentLoaded", init);

		// Event Listeners
		document.getElementById("clear-session")?.addEventListener("click", () => {
			state.lastPostId = "";
			state.lastCommentId = "";
			saveSession();
			updateTokenView();
			setLog("세션 상태를 초기화했습니다.");
		});

		document.getElementById("dart-corp-sync")?.addEventListener("click", async () => {
			try {
				const response = await apiFetch("/admin/dart/corp-sync", { method: "POST" });
				const data = await response.json();
				setLog({ status: response.status, data });
			} catch (e) {
				setLog({ error: e.message });
			}
		});

		document.getElementById("report-import")?.addEventListener("click", async () => {
			const quarterKey = readNumber("report-quarter-key", null);
			if (!quarterKey) {
				setLog("quarterKey를 입력해주세요.");
				return;
			}

			const fileInput = document.getElementById("report-file");
			const file = fileInput?.files?.[0];
			if (!file) {
				setLog("업로드 파일을 선택해주세요.");
				return;
			}

			const formData = new FormData();
			formData.append("quarterKey", String(quarterKey));
			formData.append("file", file);

			try {
				const response = await apiFetch("/admin/reports/metrics/import", {
					method: "POST",
					body: formData
				});
				const data = await response.json();
				setLog({ status: response.status, data });
			} catch (e) {
				setLog({ error: e.message });
			}
		});

		document.getElementById("predict-import")?.addEventListener("click", async () => {
			const stockCode = readText("predict-stock-code");
			const quarterKey = readNumber("predict-quarter-key", null);
			const metricsRaw = readText("predict-metrics");

			if (!stockCode) {
				setLog("stockCode를 입력해주세요.");
				return;
			}
			if (!quarterKey) {
				setLog("quarterKey를 입력해주세요.");
				return;
			}
			if (!metricsRaw) {
				setLog("metrics JSON을 입력해주세요.");
				return;
			}

			let metrics;
			try {
				metrics = JSON.parse(metricsRaw);
			} catch (e) {
				setLog("metrics JSON 파싱 실패: " + e.message);
				return;
			}

			try {
				const response = await apiFetch("/admin/reports/metrics/predict", {
					method: "POST",
					headers: { "Content-Type": "application/json" },
					body: JSON.stringify({
						stockCode,
						quarterKey,
						metrics
					})
				});
				const data = await response.json();
				setLog({ status: response.status, data });
			} catch (e) {
				setLog({ error: e.message });
			}
		});

		document.getElementById("publish-report")?.addEventListener("click", async () => {
			const stockCode = readText("publish-stock-code");
			const quarterKey = readNumber("publish-quarter-key", null);
			const valueType = document.getElementById("publish-value-type")?.value || "ACTUAL";
			const metricsRaw = readText("publish-metrics");
			const fileInput = document.getElementById("publish-file");
			const file = fileInput?.files?.[0];

			if (!stockCode) {
				setLog("stockCode를 입력해주세요.");
				return;
			}
			if (!quarterKey) {
				setLog("quarterKey를 입력해주세요.");
				return;
			}
			if (!metricsRaw) {
				setLog("metrics JSON을 입력해주세요.");
				return;
			}
			if (!file) {
				setLog("PDF 파일을 선택해주세요.");
				return;
			}

			let metrics;
			try {
				metrics = JSON.parse(metricsRaw);
			} catch (e) {
				setLog("metrics JSON 파싱 실패: " + e.message);
				return;
			}

			const formData = new FormData();
			formData.append("stockCode", stockCode);
			formData.append("quarterKey", String(quarterKey));
			formData.append("valueType", valueType);
			formData.append("metrics", JSON.stringify(metrics));
			formData.append("file", file);

			try {
				const response = await apiFetch("/admin/reports/metrics/publish", {
					method: "POST",
					body: formData
				});
				const data = await response.json();
				setLog({ status: response.status, data });
			} catch (e) {
				setLog({ error: e.message });
			}
		});

		document.getElementById("report-grouped-query")?.addEventListener("click", async () => {
			const stockCode = readText("report-stock-code");
			const fromQuarterKey = readNumber("report-from-quarter-key", null);
			const toQuarterKey = readNumber("report-to-quarter-key", null);
			if (!stockCode) {
				setLog("stockCode를 입력해주세요.");
				return;
			}
			if (!fromQuarterKey || !toQuarterKey) {
				setLog("fromQuarterKey와 toQuarterKey를 입력해주세요.");
				return;
			}

			try {
					const url = `/reports/metrics/grouped?stockCode=${encodeURIComponent(stockCode)}&fromQuarterKey=${fromQuarterKey}&toQuarterKey=${toQuarterKey}`;
				const response = await apiFetch(url);
				const data = await response.json();
				setLog({ status: response.status, data });
			} catch (e) {
				setLog({ error: e.message });
			}
		});

		const companyKeywordInput = document.getElementById("report-company-keyword");
		const companySearchButton = document.getElementById("report-company-search");
		const companyResultBox = document.getElementById("report-company-results");
		let companySearchTimer = null;

		const clearCompanyResults = () => {
			if (companyResultBox) {
				companyResultBox.innerHTML = "";
			}
		};

		const renderCompanyResults = (items) => {
			if (!companyResultBox) {
				return;
			}
			companyResultBox.innerHTML = "";
			if (!items || items.length === 0) {
				const empty = document.createElement("div");
				empty.className = "list-empty";
				empty.textContent = "검색 결과가 없습니다.";
				companyResultBox.appendChild(empty);
				return;
			}
			items.forEach((item) => {
				const button = document.createElement("button");
				button.type = "button";
				button.className = "list-item";
				button.textContent = `${item.corpName} (${item.stockCode || "-"})`;
				button.addEventListener("click", () => {
					const stockInput = document.getElementById("report-stock-code");
					if (stockInput) {
						stockInput.value = item.stockCode || "";
					}
					setLog(`선택됨: ${item.corpName} / ${item.stockCode || "-"}`);
				});
				companyResultBox.appendChild(button);
			});
		};

		const fetchCompanyResults = async (keyword) => {
			if (!keyword || keyword.length < 2) {
				setLog("기업명 검색은 2자 이상 입력해주세요.");
				clearCompanyResults();
				return;
			}
			try {
					const url = `/companies/search?keyword=${encodeURIComponent(keyword)}`;
				const response = await apiFetch(url);
				const payload = await response.json();
				if (!response.ok || !payload.success) {
					setLog({ status: response.status, data: payload });
					clearCompanyResults();
					return;
				}
				renderCompanyResults(payload.data || []);
			} catch (e) {
				setLog({ error: e.message });
			}
		};

		const scheduleCompanySearch = (keyword) => {
			if (companySearchTimer) {
				clearTimeout(companySearchTimer);
			}
			if (!keyword || keyword.trim().length < 2) {
				clearCompanyResults();
				return;
			}
			companySearchTimer = setTimeout(() => {
				fetchCompanyResults(keyword.trim());
			}, 300);
		};

		companyKeywordInput?.addEventListener("input", (event) => {
			scheduleCompanySearch(event.target.value);
		});

		companySearchButton?.addEventListener("click", () => {
			const keyword = readText("report-company-keyword");
			fetchCompanyResults(keyword.trim());
		});

		document.getElementById("list-posts")?.addEventListener("click", async () => {
			const page = readNumber("page", 1);
			const size = readNumber("size", 10);
			const sortBy = readText("sortBy") || "createdAt";
			const direction = document.getElementById("direction").value || "DESC";

			try {
				const url = `/posts?page=${page}&size=${size}&sortBy=${encodeURIComponent(sortBy)}&direction=${direction}`;
				const response = await apiFetch(url);
				const data = await response.json();
				setLog({ status: response.status, data });
				if (response.ok && data.data && data.data.content && data.data.content.length > 0) {
					state.lastPostId = data.data.content[0].id;
					saveSession();
					updateTokenView();
				}
			} catch (e) {
				setLog({ error: e.message });
			}
		});

		document.getElementById("create-post")?.addEventListener("click", async () => {
			const payload = {
				categoryId: readNumber("create-category", null),
				title: readText("create-title"),
				content: readText("create-content")
			};
			try {
				const response = await apiFetch("/posts", {
					method: "POST",
					headers: { "Content-Type": "application/json" },
					body: JSON.stringify(payload)
				});
				const data = await response.json();
				setLog({ status: response.status, data });
				if (response.ok && data.data) {
					state.lastPostId = data.data.id;
					saveSession();
					updateTokenView();
				}
			} catch (e) {
				setLog({ error: e.message });
			}
		});

		document.getElementById("get-post")?.addEventListener("click", async () => {
			const postId = readNumber("post-id", state.lastPostId);
			if (!postId) {
				setLog("postId를 입력해주세요.");
				return;
			}
			try {
				const response = await apiFetch(`/posts/${postId}`);
				const data = await response.json();
				setLog({ status: response.status, data });
			} catch (e) {
				setLog({ error: e.message });
			}
		});

		document.getElementById("update-post")?.addEventListener("click", async () => {
			const postId = readNumber("post-id", state.lastPostId);
			if (!postId) {
				setLog("postId를 입력해주세요.");
				return;
			}
			const payload = {
				title: readText("update-title"),
				content: readText("update-content"),
				categoryId: readNumber("update-category", null)
			};
			try {
				const response = await apiFetch(`/posts/${postId}`, {
					method: "PATCH",
					headers: { "Content-Type": "application/json" },
					body: JSON.stringify(payload)
				});
				const data = await response.json();
				setLog({ status: response.status, data });
			} catch (e) {
				setLog({ error: e.message });
			}
		});

		document.getElementById("delete-post")?.addEventListener("click", async () => {
			const postId = readNumber("post-id", state.lastPostId);
			if (!postId) {
				setLog("postId를 입력해주세요.");
				return;
			}
			try {
				const response = await apiFetch(`/posts/${postId}`, { method: "DELETE" });
				const data = await response.json();
				setLog({ status: response.status, data });
			} catch (e) {
				setLog({ error: e.message });
			}
		});

		document.getElementById("list-comments")?.addEventListener("click", async () => {
			const postId = readNumber("comment-post-id", state.lastPostId);
			if (!postId) {
				setLog("postId를 입력해주세요.");
				return;
			}
			try {
				const response = await apiFetch(`/posts/${postId}/comments`);
				const data = await response.json();
				setLog({ status: response.status, data });
				if (response.ok && data.data) {
					renderCommentTree(data.data);
					if (data.data.length > 0) {
						state.lastCommentId = data.data[0].id;
						saveSession();
						updateTokenView();
					}
				}
			} catch (e) {
				setLog({ error: e.message });
			}
		});

		document.getElementById("create-comment")?.addEventListener("click", async () => {
			const postId = readNumber("comment-post-id", state.lastPostId);
			if (!postId) {
				setLog("postId를 입력해주세요.");
				return;
			}
			const parentIdValue = readText("comment-parent");
			const payload = {
				postId,
				content: readText("comment-content")
			};
			if (parentIdValue) {
				payload.parentId = Number(parentIdValue);
			}
			try {
				const response = await apiFetch(`/posts/${postId}/comments`, {
					method: "POST",
					headers: { "Content-Type": "application/json" },
					body: JSON.stringify(payload)
				});
				const data = await response.json();
				setLog({ status: response.status, data });
				if (response.ok && data.data) {
					state.lastCommentId = data.data.id;
					saveSession();
					updateTokenView();
				}
			} catch (e) {
				setLog({ error: e.message });
			}
		});

		document.getElementById("update-comment")?.addEventListener("click", async () => {
			const commentId = readNumber("comment-id", state.lastCommentId);
			if (!commentId) {
				setLog("commentId를 입력해주세요.");
				return;
			}
			const payload = { content: readText("comment-update") };
			try {
				const response = await apiFetch(`/comments/${commentId}`, {
					method: "PATCH",
					headers: { "Content-Type": "application/json" },
					body: JSON.stringify(payload)
				});
				const data = await response.json();
				setLog({ status: response.status, data });
			} catch (e) {
				setLog({ error: e.message });
			}
		});

		document.getElementById("delete-comment")?.addEventListener("click", async () => {
			const commentId = readNumber("comment-id", state.lastCommentId);
			if (!commentId) {
				setLog("commentId를 입력해주세요.");
				return;
			}
			try {
				const response = await apiFetch(`/comments/${commentId}`, { method: "DELETE" });
				const data = await response.json();
				setLog({ status: response.status, data });
			} catch (e) {
				setLog({ error: e.message });
			}
		});
	</script>
</body>
</html>
