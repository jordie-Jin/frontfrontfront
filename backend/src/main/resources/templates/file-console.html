<!doctype html>
<html lang="ko">
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>File Upload Console</title>
	<link rel="preconnect" href="https://fonts.googleapis.com">
	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link href="https://fonts.googleapis.com/css2?family=Newsreader:opsz,wght@6..72,400;6..72,600&family=Space+Grotesk:wght@400;600;700&display=swap" rel="stylesheet">
	<style>
		:root {
			--ink: #10131a;
			--ink-soft: #2f3340;
			--muted: #6f7484;
			--accent: #ff6b3d;
			--accent-2: #3d7bff;
			--accent-3: #13b886;
			--paper: #f5f0e8;
			--card: #ffffff;
			--line: #e7e1d6;
			--shadow: 0 20px 50px rgba(16, 19, 26, 0.16);
			--radius: 20px;
		}

		* {
			box-sizing: border-box;
		}

		body {
			margin: 0;
			font-family: "Space Grotesk", "Apple SD Gothic Neo", "Malgun Gothic", sans-serif;
			color: var(--ink);
			background: radial-gradient(circle at 20% 20%, #fff1df 0%, transparent 55%),
				radial-gradient(circle at 80% 0%, #e7efff 0%, transparent 52%),
				linear-gradient(180deg, #f8f3ea 0%, #efe8dd 100%);
			min-height: 100vh;
		}

		.shell {
			max-width: 980px;
			margin: 0 auto;
			padding: 40px 24px 64px;
			display: grid;
			gap: 24px;
		}

		.header {
			display: grid;
			gap: 8px;
			animation: rise 0.7s ease both;
		}

		.title {
			font-family: "Newsreader", serif;
			font-size: clamp(28px, 3vw, 44px);
			margin: 0;
			letter-spacing: -0.02em;
		}

		.subtitle {
			margin: 0;
			color: var(--muted);
			font-size: 14px;
		}

		.card {
			background: var(--card);
			border-radius: var(--radius);
			padding: 22px;
			box-shadow: var(--shadow);
			border: 1px solid var(--line);
			animation: floatIn 0.7s ease both;
		}

		.card h2 {
			margin: 0 0 14px;
			font-size: 18px;
		}

		label {
			font-size: 13px;
			color: var(--muted);
			display: block;
			margin-bottom: 6px;
		}

		input[type="text"],
		input[type="number"] {
			width: 100%;
			padding: 12px 14px;
			border-radius: 12px;
			border: 1px solid #e8e2d8;
			font-family: inherit;
			font-size: 14px;
			background: #fbfaf8;
			color: var(--ink);
		}

		.file-box {
			display: grid;
			gap: 10px;
			border: 1px dashed #d8d0c3;
			border-radius: 14px;
			padding: 16px;
			background: #fbfaf8;
		}

		.file-box input[type="file"] {
			width: 100%;
		}

		.hint {
			font-size: 12px;
			color: var(--muted);
		}

		.actions {
			display: flex;
			gap: 10px;
			flex-wrap: wrap;
			margin-top: 14px;
		}

		button {
			border: none;
			border-radius: 999px;
			padding: 10px 18px;
			font-weight: 600;
			cursor: pointer;
			font-family: inherit;
			transition: transform 0.2s ease, box-shadow 0.2s ease;
		}

		button.primary {
			background: var(--accent);
			color: #fff;
		}

		button.secondary {
			background: #fff;
			color: var(--ink-soft);
			border: 1px solid var(--line);
		}

		button:hover {
			transform: translateY(-2px);
			box-shadow: 0 10px 20px rgba(16, 19, 26, 0.12);
		}

		.token-preview {
			display: grid;
			gap: 6px;
			font-size: 12px;
			color: var(--muted);
		}

		.list {
			margin: 0;
			padding-left: 18px;
			color: var(--ink-soft);
			font-size: 13px;
		}

		.log {
			background: #0e1116;
			color: #f8f8f2;
			border-radius: 16px;
			padding: 16px;
			font-size: 12px;
			min-height: 160px;
			white-space: pre-wrap;
		}

		.file-list {
			display: grid;
			gap: 12px;
			margin-top: 16px;
		}

		.file-item {
			border: 1px solid var(--line);
			border-radius: 16px;
			padding: 14px 16px;
			background: #fbfaf8;
			display: grid;
			gap: 6px;
		}

		.file-title {
			font-weight: 600;
		}

		.file-meta {
			font-size: 12px;
			color: var(--muted);
		}

		@keyframes rise {
			from {
				opacity: 0;
				transform: translateY(12px);
			}
			to {
				opacity: 1;
				transform: translateY(0);
			}
		}

		@keyframes floatIn {
			from {
				opacity: 0;
				transform: translateY(18px);
			}
			to {
				opacity: 1;
				transform: translateY(0);
			}
		}
	</style>
</head>
<body>
	<div class="shell">
		<header class="header">
			<h1 class="title">File Upload Console</h1>
			<p class="subtitle">개발 환경에서 파일 업로드를 빠르게 검증합니다. Auth Console에서 발급한 토큰을 자동으로 사용합니다.</p>
		</header>

		<section class="card" style="animation-delay: 0.05s;">
			<h2>토큰 상태</h2>
			<div class="token-preview">
				<span>Access Token: <strong id="access-preview">-</strong></span>
				<span>Refresh Token: <strong id="refresh-preview">-</strong></span>
			</div>
		</section>

		<section class="card" style="animation-delay: 0.12s;">
			<h2>파일 업로드</h2>
			<label for="post-id">postId</label>
			<input id="post-id" type="number" placeholder="업로드할 게시글 ID">

			<div class="file-box" style="margin-top: 12px;">
				<label for="file-input">files</label>
				<input id="file-input" type="file" multiple>
				<div class="hint" id="file-hint">선택된 파일이 없습니다.</div>
			</div>

			<div class="actions">
				<button class="primary" id="upload-btn" type="button">업로드</button>
				<button class="secondary" id="clear-btn" type="button">로그 초기화</button>
			</div>

			<ul class="list" style="margin-top: 12px;">
				<li>요청 경로: <code>/posts/{postId}/files</code></li>
				<li>파일은 multipart/form-data로 전송됩니다.</li>
				<li>토큰이 없다면 Auth Console에서 로그인 후 다시 시도하세요.</li>
			</ul>
		</section>

		<section class="card" style="animation-delay: 0.16s;">
			<h2>업로드 파일 조회</h2>
			<label for="list-post-id">postId</label>
			<input id="list-post-id" type="number" placeholder="조회할 게시글 ID">
			<div class="actions">
				<button class="secondary" id="list-btn" type="button">목록 조회</button>
			</div>
			<div id="file-list" class="file-list">조회된 파일이 없습니다.</div>
		</section>

		<section class="card" style="animation-delay: 0.2s;">
			<h2>응답 로그</h2>
			<pre class="log" id="log">대기 중...</pre>
		</section>
	</div>

	<script>
		const storageKey = "auth-console.tokens";
		const logEl = document.getElementById("log");
		const fileInput = document.getElementById("file-input");
		const fileHint = document.getElementById("file-hint");
		const uploadBtn = document.getElementById("upload-btn");
		const clearBtn = document.getElementById("clear-btn");
		const postIdInput = document.getElementById("post-id");
		const listPostIdInput = document.getElementById("list-post-id");
		const listBtn = document.getElementById("list-btn");
		const fileListEl = document.getElementById("file-list");
		const accessPreview = document.getElementById("access-preview");
		const refreshPreview = document.getElementById("refresh-preview");

		const state = {
			accessToken: "",
			refreshToken: ""
		};

		const setLog = (payload) => {
			logEl.textContent = typeof payload === "string" ? payload : JSON.stringify(payload, null, 2);
		};

		const loadTokens = () => {
			try {
				const raw = localStorage.getItem(storageKey);
				if (raw) {
					const data = JSON.parse(raw);
					state.accessToken = data.accessToken || "";
					state.refreshToken = data.refreshToken || "";
				}
			} catch (e) {
				setLog("토큰 로드 실패: " + e.message);
			}
			accessPreview.textContent = state.accessToken ? state.accessToken.slice(0, 30) + "..." : "-";
			refreshPreview.textContent = state.refreshToken ? state.refreshToken.slice(0, 30) + "..." : "-";
		};

		const updateFileHint = () => {
			if (!fileInput.files || fileInput.files.length === 0) {
				fileHint.textContent = "선택된 파일이 없습니다.";
				return;
			}
			const items = Array.from(fileInput.files).map((file) => {
				return `${file.name} (${Math.round(file.size / 1024)} KB)`;
			});
			fileHint.textContent = items.join(", ");
		};

		const uploadFiles = async () => {
			const postId = postIdInput.value;
			if (!postId) {
				setLog("postId를 입력하세요.");
				return;
			}
			if (!fileInput.files || fileInput.files.length === 0) {
				setLog("업로드할 파일을 선택하세요.");
				return;
			}
			if (!state.accessToken) {
				setLog("Access Token이 없습니다. Auth Console에서 로그인 후 다시 시도하세요.");
				return;
			}

			const formData = new FormData();
			Array.from(fileInput.files).forEach((file) => {
				formData.append("files", file);
			});

			setLog("업로드 요청 중...");

			try {
				const response = await fetch(`/posts/${postId}/files`, {
					method: "POST",
					headers: {
						Authorization: "Bearer " + state.accessToken
					},
					body: formData
				});
				const text = await response.text();
				let data = text;
				try {
					data = JSON.parse(text);
				} catch (e) {
					// ignore
				}
				setLog({ status: response.status, body: data });
			} catch (e) {
				setLog("업로드 실패: " + e.message);
			}
		};

		const fetchFileList = async () => {
			const postId = listPostIdInput.value;
			if (!postId) {
				setLog("조회할 postId를 입력하세요.");
				return;
			}
			if (!state.accessToken) {
				setLog("Access Token이 없습니다. Auth Console에서 로그인 후 다시 시도하세요.");
				return;
			}

			setLog("파일 목록 조회 중...");
			try {
				const response = await fetch(`/posts/${postId}/files`, {
					method: "GET",
					headers: {
						Authorization: "Bearer " + state.accessToken
					}
				});
				const text = await response.text();
				let data = text;
				try {
					data = JSON.parse(text);
				} catch (e) {
					// ignore
				}
				if (!response.ok) {
					setLog({ status: response.status, body: data });
					return;
				}
				renderFileList(data.data || []);
				setLog({ status: response.status, body: data });
			} catch (e) {
				setLog("파일 목록 조회 실패: " + e.message);
			}
		};

		const renderFileList = (items) => {
			if (!fileListEl) return;
			fileListEl.innerHTML = "";
			if (!items || items.length === 0) {
				fileListEl.textContent = "조회된 파일이 없습니다.";
				return;
			}
			items.forEach((item) => {
				const wrapper = document.createElement("div");
				wrapper.className = "file-item";

				const title = document.createElement("div");
				title.className = "file-title";
				title.textContent = `${item.originalFilename} (${Math.round(item.fileSize / 1024)} KB)`;

				const meta = document.createElement("div");
				meta.className = "file-meta";
				meta.textContent = `${item.contentType} · id=${item.id}`;

				const actions = document.createElement("div");
				actions.className = "actions";

				const viewBtn = document.createElement("button");
				viewBtn.type = "button";
				viewBtn.className = "secondary";
				viewBtn.textContent = "보기";
				viewBtn.addEventListener("click", () => openFile(item.id));

				const downloadBtn = document.createElement("button");
				downloadBtn.type = "button";
				downloadBtn.className = "primary";
				downloadBtn.textContent = "다운로드";
				downloadBtn.addEventListener("click", () => downloadFile(item.id, item.originalFilename));

				actions.appendChild(viewBtn);
				actions.appendChild(downloadBtn);

				wrapper.appendChild(title);
				wrapper.appendChild(meta);
				wrapper.appendChild(actions);
				fileListEl.appendChild(wrapper);
			});
		};

		const fetchFileBlob = async (fileId) => {
			const response = await fetch(`/files/${fileId}`, {
				method: "GET",
				headers: {
					Authorization: "Bearer " + state.accessToken
				}
			});
			if (!response.ok) {
				const text = await response.text();
				throw new Error(text);
			}
			const blob = await response.blob();
			return { blob, contentType: response.headers.get("Content-Type") || blob.type };
		};

		const openFile = async (fileId) => {
			try {
				const { blob } = await fetchFileBlob(fileId);
				const url = URL.createObjectURL(blob);
				window.open(url, "_blank");
				setTimeout(() => URL.revokeObjectURL(url), 60000);
			} catch (e) {
				setLog("파일 열기 실패: " + e.message);
			}
		};

		const downloadFile = async (fileId, filename) => {
			try {
				const { blob } = await fetchFileBlob(fileId);
				const url = URL.createObjectURL(blob);
				const link = document.createElement("a");
				link.href = url;
				link.download = filename || `file-${fileId}`;
				document.body.appendChild(link);
				link.click();
				link.remove();
				setTimeout(() => URL.revokeObjectURL(url), 60000);
			} catch (e) {
				setLog("다운로드 실패: " + e.message);
			}
		};

		fileInput.addEventListener("change", updateFileHint);
		uploadBtn.addEventListener("click", uploadFiles);
		listBtn.addEventListener("click", fetchFileList);
		clearBtn.addEventListener("click", () => setLog("대기 중..."));

		loadTokens();
		updateFileHint();
	</script>
</body>
</html>
